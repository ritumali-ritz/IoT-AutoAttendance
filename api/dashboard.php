<?php header('Content-Type: application/json'); require 'db.php'; $class_id = isset($_GET['class_id'])?intval($_GET['class_id']):0; $where = $class_id?"WHERE c.id={$class_id}":''; $res = $mysqli->query("SELECT COUNT(DISTINCT s.roll_no) AS total_students FROM students s LEFT JOIN classes c ON s.class_id=c.id {$where}"); $total = $res->fetch_assoc()['total_students']; $today = date('Y-m-d'); $res2 = $mysqli->query("SELECT COUNT(DISTINCT a.roll_no) AS present FROM attendance a LEFT JOIN students s ON a.roll_no=s.roll_no LEFT JOIN classes c ON s.class_id=c.id WHERE a.date='{$today}' ".($class_id?"AND c.id={$class_id}":"")); $present = $res2->fetch_assoc()['present']; $percent = $total? round(($present/$total)*100,2):0; // simple labels last 7 days
$labels=[]; $data=[]; for($i=6;$i>=0;$i--){ $d=date('Y-m-d', strtotime("-{$i} days")); $labels[]=$d; $r=$mysqli->query("SELECT COUNT(DISTINCT roll_no) AS c FROM attendance WHERE date='{$d}'"); $data[]=$r->fetch_assoc()['c']; }
echo json_encode(['total_students'=>intval($total),'present_today'=>intval($present),'att_percent'=>floatval($percent),'labels'=>$labels,'data'=>$data]); ?>